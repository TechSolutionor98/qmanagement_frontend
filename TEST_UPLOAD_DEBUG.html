<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        button:hover {
            background: #45a049;
        }
        .log {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        input[type="file"] {
            margin: 10px 0;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Direct Upload Debug Test</h1>
        <p>Test upload directly to backend to check Content-Length issue</p>
        
        <input type="file" id="videoFile" accept="video/*">
        <button onclick="testUpload()">Test Upload</button>
        <button onclick="clearLog()">Clear Log</button>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function testUpload() {
            const fileInput = document.getElementById('videoFile');
            const file = fileInput.files[0];
            
            if (!file) {
                log('‚ùå Please select a video file first!', 'error');
                return;
            }

            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            log(`üìπ File selected: ${file.name}`, 'info');
            log(`üì¶ File size: ${fileSizeMB} MB`, 'info');
            log(`üìÑ File type: ${file.type}`, 'info');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

            // Create FormData
            const formData = new FormData();
            formData.append('video', file);
            formData.append('admin_id', '1'); // Test admin_id

            log('üì¶ FormData created', 'success');
            log(`   - Has video: ${formData.has('video')}`, 'info');
            log(`   - Has admin_id: ${formData.has('admin_id')}`, 'info');
            
            // Check FormData entries
            for (let [key, value] of formData.entries()) {
                if (value instanceof File) {
                    log(`   - ${key}: File(${value.name}, ${value.size} bytes)`, 'info');
                } else {
                    log(`   - ${key}: ${value}`, 'info');
                }
            }

            const uploadUrl = 'https://queapi.techmanagement.tech/api/counter-display/upload-video';
            log(`üéØ Upload URL: ${uploadUrl}`, 'info');
            log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê', 'info');

            try {
                log('üöÄ Starting XMLHttpRequest upload...', 'info');
                
                const xhr = new XMLHttpRequest();
                
                // Progress tracking
                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percentComplete = Math.round((e.loaded / e.total) * 100);
                        log(`üìä Upload progress: ${percentComplete}% (${(e.loaded / (1024*1024)).toFixed(2)}MB / ${(e.total / (1024*1024)).toFixed(2)}MB)`, 'info');
                    }
                });

                xhr.addEventListener('load', () => {
                    log(`üì• Response status: ${xhr.status}`, xhr.status === 200 ? 'success' : 'error');
                    log(`üì• Response text: ${xhr.responseText}`, 'info');
                    
                    if (xhr.status === 200) {
                        log('‚úÖ Upload successful!', 'success');
                    } else {
                        log('‚ùå Upload failed!', 'error');
                    }
                });

                xhr.addEventListener('error', () => {
                    log('‚ùå Network Error - Request failed completely', 'error');
                    log('   This means request did not reach server', 'error');
                });

                xhr.addEventListener('abort', () => {
                    log('‚ö†Ô∏è Upload aborted', 'error');
                });

                xhr.addEventListener('timeout', () => {
                    log('‚è±Ô∏è Upload timeout', 'error');
                });

                xhr.open('POST', uploadUrl);
                
                // Set headers manually to see what happens
                xhr.setRequestHeader('Authorization', 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwicm9sZSI6ImFkbWluIiwiaWF0IjoxNzM0OTY4NDU0LCJleHAiOjE3MzUwNTQ4NTR9.OqCvI_ZKKFQ8r3gvjmrL2NZCj1mCvTOOsKXHPBv_qzw'); // Replace with actual token
                // DON'T set Content-Type - let browser set it with boundary
                
                xhr.timeout = 600000; // 10 minutes
                
                log('üì§ Sending request...', 'info');
                log(`   - Method: POST`, 'info');
                log(`   - Content-Length will be: ${file.size}`, 'info');
                log(`   - Timeout: 10 minutes`, 'info');
                
                // IMPORTANT: Check request headers before sending
                xhr.addEventListener('loadstart', () => {
                    log('üîÑ Request started (loadstart event)', 'info');
                });

                xhr.send(formData);
                log('‚úÖ xhr.send() called successfully', 'success');

            } catch (error) {
                log(`‚ùå JavaScript Error: ${error.message}`, 'error');
                log(`   Stack: ${error.stack}`, 'error');
            }
        }
    </script>
</body>
</html>
