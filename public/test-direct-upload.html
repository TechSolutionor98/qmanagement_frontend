<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Direct Upload Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .log {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            margin-top: 15px;
            border-radius: 5px;
            max-height: 500px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 11px;
            line-height: 1.4;
        }
        .error { color: #d32f2f; font-weight: bold; }
        .success { color: #388e3c; font-weight: bold; }
        .info { color: #1976d2; }
        .warning { color: #f57c00; }
        button {
            background: #4CAF50;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover { background: #45a049; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        input[type="file"] {
            margin: 10px 0;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            width: 100%;
        }
        .progress {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
            display: none;
        }
        .progress-bar {
            height: 100%;
            background: #4CAF50;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ Direct Video Upload Test (XHR)</h1>
        <p><strong>Purpose:</strong> Test video upload with XMLHttpRequest to see exact network behavior</p>
        
        <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 10px 0;">
            <strong>ğŸ“ Instructions:</strong><br>
            1. Select a SMALL video (5-20MB for testing)<br>
            2. Click "Test Upload"<br>
            3. Open Browser DevTools (F12) â†’ Network tab<br>
            4. Watch for OPTIONS and POST requests
        </div>

        <input type="file" id="videoFile" accept="video/*">
        
        <div>
            <button onclick="testUpload()">ğŸš€ Test Upload</button>
            <button onclick="testCORS()">ğŸ” Test CORS Preflight</button>
            <button onclick="clearLog()">ğŸ—‘ï¸ Clear Log</button>
        </div>

        <div class="progress" id="progress">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        const API_URL = 'https://queapi.techmanagement.tech/api';
        const UPLOAD_URL = `${API_URL}/counter-display/upload-video`;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const className = type;
            logDiv.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
            document.getElementById('progress').style.display = 'none';
        }

        async function testCORS() {
            clearLog();
            log('ğŸ” Testing CORS Preflight (OPTIONS request)...', 'info');
            log(`Target: ${UPLOAD_URL}`, 'info');
            
            try {
                const response = await fetch(UPLOAD_URL, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'authorization,content-type'
                    }
                });
                
                log(`âœ… OPTIONS Response Status: ${response.status}`, 'success');
                log(`Headers received:`, 'info');
                response.headers.forEach((value, key) => {
                    log(`   ${key}: ${value}`, 'info');
                });
                
            } catch (error) {
                log(`âŒ OPTIONS request failed: ${error.message}`, 'error');
                log(`This means CORS preflight is failing!`, 'error');
            }
        }

        function testUpload() {
            const fileInput = document.getElementById('videoFile');
            const file = fileInput.files[0];
            
            if (!file) {
                log('âŒ Please select a video file first!', 'error');
                return;
            }

            clearLog();
            
            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            log('ğŸ¬ STARTING VIDEO UPLOAD TEST', 'info');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            log(`ğŸ“¹ File: ${file.name}`, 'info');
            log(`ğŸ“¦ Size: ${fileSizeMB} MB`, 'info');
            log(`ğŸ¯ URL: ${UPLOAD_URL}`, 'info');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');

            const formData = new FormData();
            formData.append('video', file);
            formData.append('admin_id', '8');

            const xhr = new XMLHttpRequest();

            // Show progress bar
            document.getElementById('progress').style.display = 'block';
            
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    const progressBar = document.getElementById('progressBar');
                    progressBar.style.width = percentComplete + '%';
                    progressBar.textContent = percentComplete + '%';
                    log(`ğŸ“Š Upload: ${percentComplete}% (${(e.loaded / (1024*1024)).toFixed(2)}MB / ${(e.total / (1024*1024)).toFixed(2)}MB)`, 'info');
                }
            });

            xhr.upload.addEventListener('loadstart', () => {
                log('ğŸš€ Upload started (loadstart event)', 'info');
            });

            xhr.addEventListener('readystatechange', () => {
                log(`ğŸ“¡ ReadyState changed: ${xhr.readyState} (${getReadyStateText(xhr.readyState)})`, 'info');
            });

            xhr.addEventListener('load', () => {
                log('âœ… Upload load event fired', 'success');
                log(`ğŸ“¥ Response Status: ${xhr.status} ${xhr.statusText}`, xhr.status === 200 ? 'success' : 'error');
                log(`ğŸ“¥ Response: ${xhr.responseText.substring(0, 500)}`, 'info');
                
                if (xhr.status === 200) {
                    log('ğŸ‰ SUCCESS! Video uploaded!', 'success');
                } else {
                    log('âŒ Upload failed with status: ' + xhr.status, 'error');
                }
            });

            xhr.addEventListener('error', (e) => {
                log('âŒ XHR ERROR EVENT FIRED!', 'error');
                log('   This means: Request completely failed to reach server', 'error');
                log('   Possible causes:', 'warning');
                log('   1. CORS preflight (OPTIONS) failed', 'warning');
                log('   2. Network connection lost', 'warning');
                log('   3. Browser blocked the request', 'warning');
                log('   4. SSL/Certificate issue', 'warning');
                log(`   Error object: ${JSON.stringify(e)}`, 'error');
            });

            xhr.addEventListener('abort', () => {
                log('âš ï¸ Upload aborted by user or timeout', 'warning');
            });

            xhr.addEventListener('timeout', () => {
                log('â±ï¸ Upload timeout!', 'error');
            });

            xhr.open('POST', UPLOAD_URL);
            
            // Set headers
            xhr.setRequestHeader('Authorization', 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6OCwicm9sZSI6ImFkbWluIiwiaWF0IjoxNzM1MDMxNTM5LCJleHAiOjE3MzUxMTc5Mzl9.vYlIb3XXGCPHvnGxgI_3L0VroCqaDbNNfcYmgzJ9QpQ');
            // DON'T set Content-Type - browser will set it with boundary
            
            xhr.timeout = 600000; // 10 minutes
            
            log('ğŸ“¤ Sending request...', 'info');
            log('   Method: POST', 'info');
            log('   Authorization: Bearer token present', 'info');
            log('   Body: FormData with video file', 'info');
            log('   Timeout: 10 minutes', 'info');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            log('âš ï¸ IMPORTANT: Check Browser DevTools Network tab!', 'warning');
            log('   Look for:', 'warning');
            log('   1. OPTIONS request (preflight)', 'warning');
            log('   2. POST request (actual upload)', 'warning');
            log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
            
            xhr.send(formData);
        }

        function getReadyStateText(state) {
            const states = {
                0: 'UNSENT',
                1: 'OPENED',
                2: 'HEADERS_RECEIVED',
                3: 'LOADING',
                4: 'DONE'
            };
            return states[state] || 'UNKNOWN';
        }
    </script>
</body>
</html>
